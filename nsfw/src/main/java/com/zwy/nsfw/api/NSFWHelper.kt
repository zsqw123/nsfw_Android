package com.zwy.nsfw.api

import android.graphics.Bitmap
import com.zwy.nsfw.core.Classifier
import com.zwy.nsfw.core.NSFWConfig
import com.zwy.nsfw.core.NsfwBean
import java.lang.Exception

object NSFWHelper {
    private lateinit var classifier: Classifier
    private var isInit = false
    @Synchronized
    fun init(nsfwConfig: NSFWConfig): NSFWHelper {
        if (nsfwConfig.assetMannager != null) {
            classifier = Classifier.create(nsfwConfig.assetMannager, nsfwConfig.userGPU, 10)
            isInit = true
            return this
        } else if (nsfwConfig.file != null) {
            classifier = Classifier.create(isAddGpuDelegate = nsfwConfig.userGPU, numThreads = 10, file = nsfwConfig.file)
            isInit = true
            return this
        }
        throw Exception("no lib detect")
    }

    /**
     * 同步扫描图片(建议使用者自己放在线程中处理)
     */
    @Synchronized
    fun scanBitmap(bitmap: Bitmap): NsfwBean {
        if (!isInit) {
            throw ExceptionInInitializerError("Initialize the scanned object 'NSFWHelper.init(nsfwConfig: NSFWConfig)' by calling the function first.")
        }
        return classifier.run(bitmap)
    }

    /**
     * 不会销毁该单利和配置的参数，建议页面处理完成后调用该代码对扫描器进行关闭,关闭后下次扫描不需要再次调用init方法
     */
    fun destroyFactory() {
        classifier.close()
    }

}